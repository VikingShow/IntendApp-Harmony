// File: entry/src/main/ets/components/ExportDialog.ets

import { ExportService } from '../services/ExportService';
import { CommonButton } from './CommonButton';
import { ThemeConfig } from '../utils/ThemeConfig';
import promptAction from '@ohos.promptAction';

@Component
export struct ExportDialog {
  visible: boolean = false;
  projectId?: string;
  projectName?: string;
  onClose: () => void = () => {};

  private exportService: ExportService = ExportService.getInstance();

  build() {
    if (this.visible) {
      Column() {
        // æ ‡é¢˜
        Row({ space: ThemeConfig.spacingM }) {
          Text('ğŸ“¤')
            .fontSize(ThemeConfig.fontSizeXXL)
            .fontColor(ThemeConfig.primaryColor)
          Text('å¯¼å‡ºé¡¹ç›®æ•°æ®')
            .fontSize(ThemeConfig.fontSizeXXL)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeConfig.gray800)
            .layoutWeight(1)
        }
        .width('100%')
        .padding(ThemeConfig.spacingL)
        .alignItems(VerticalAlign.Center)

        // é¡¹ç›®ä¿¡æ¯
        if (this.projectName) {
          Column({ space: ThemeConfig.spacingS }) {
            Text('é¡¹ç›®åç§°')
              .fontSize(ThemeConfig.fontSizeS)
              .fontColor(ThemeConfig.gray600)
            Text(this.projectName)
              .fontSize(ThemeConfig.fontSizeL)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeConfig.gray800)
          }
          .width('100%')
          .padding(ThemeConfig.spacingL)
          .backgroundColor(ThemeConfig.gray50)
          .borderRadius(ThemeConfig.radiusMedium)
          .margin({ left: ThemeConfig.spacingL, right: ThemeConfig.spacingL })
        }

        // å¯¼å‡ºé€‰é¡¹
        Column({ space: ThemeConfig.spacingM }) {
          Text('é€‰æ‹©å¯¼å‡ºæ ¼å¼')
            .fontSize(ThemeConfig.fontSizeM)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeConfig.gray800)
            .margin({ top: ThemeConfig.spacingL })

          // å¯¼å‡ºé€‰é¡¹æŒ‰é’®
          Column({ space: ThemeConfig.spacingS }) {
            CommonButton({
              text: 'å¯¼å‡ºå½“å‰é¡¹ç›®',
              icon: 'ğŸ“‹',
              type: 'primary',
              onButtonClick: () => {
                this.exportCurrentProject();
              }
            })

            CommonButton({
              text: 'å¯¼å‡ºé¡¹ç›®æŠ¥å‘Š',
              icon: 'ğŸ“Š',
              type: 'primary',
              onButtonClick: () => {
                this.exportProjectReport();
              }
            })

            CommonButton({
              text: 'å¯¼å‡ºæ‰€æœ‰é¡¹ç›®',
              icon: 'ğŸ“',
              type: 'secondary',
              onButtonClick: () => {
                this.exportAllProjects();
              }
            })
          }
          .margin({ top: ThemeConfig.spacingM })
        }
        .padding(ThemeConfig.spacingL)

        // åº•éƒ¨æŒ‰é’®
        Row({ space: ThemeConfig.spacingM }) {
          CommonButton({
            text: 'å–æ¶ˆ',
            type: 'secondary',
            onButtonClick: () => {
              this.onClose();
            }
          })
          .layoutWeight(1)
        }
        .padding(ThemeConfig.spacingL)
      }
      .width('100%')
      .backgroundColor(ThemeConfig.white)
      .borderRadius(ThemeConfig.radiusLarge)
      .shadow(ThemeConfig.shadowLarge)
      .margin(ThemeConfig.spacingL)
    }
  }

  private async exportCurrentProject() {
    if (!this.projectId) {
      promptAction.showToast({ message: 'é¡¹ç›®IDä¸å­˜åœ¨' });
      return;
    }

    try {
      const exportData = await this.exportService.exportProject(this.projectId);
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶ä¿å­˜é€»è¾‘
      promptAction.showToast({ message: 'é¡¹ç›®æ•°æ®å¯¼å‡ºæˆåŠŸ' });
      console.log('å¯¼å‡ºæ•°æ®:', exportData);
    } catch (error) {
      promptAction.showToast({ message: 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•' });
      console.error('å¯¼å‡ºå¤±è´¥:', error);
    }
  }

  private async exportProjectReport() {
    if (!this.projectId) {
      promptAction.showToast({ message: 'é¡¹ç›®IDä¸å­˜åœ¨' });
      return;
    }

    try {
      const report = await this.exportService.generateProjectReport(this.projectId);
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶ä¿å­˜é€»è¾‘
      promptAction.showToast({ message: 'é¡¹ç›®æŠ¥å‘Šç”ŸæˆæˆåŠŸ' });
      console.log('é¡¹ç›®æŠ¥å‘Š:', report);
    } catch (error) {
      promptAction.showToast({ message: 'æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•' });
      console.error('æŠ¥å‘Šç”Ÿæˆå¤±è´¥:', error);
    }
  }

  private async exportAllProjects() {
    try {
      const exportData = await this.exportService.exportAllProjects();
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶ä¿å­˜é€»è¾‘
      promptAction.showToast({ message: 'æ‰€æœ‰é¡¹ç›®æ•°æ®å¯¼å‡ºæˆåŠŸ' });
      console.log('å¯¼å‡ºæ‰€æœ‰é¡¹ç›®æ•°æ®:', exportData);
    } catch (error) {
      promptAction.showToast({ message: 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•' });
      console.error('å¯¼å‡ºå¤±è´¥:', error);
    }
  }
} 