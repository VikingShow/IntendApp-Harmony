// File: entry/src/main/ets/components/TaskEditor.ets

import { TaskNode, ChecklistItem } from '../model/ProjectData';
import { CommonButton } from './CommonButton';
import { ValidationUtils } from '../utils/ValidationUtils';
import promptAction from '@ohos.promptAction';

@Component
export struct TaskEditor {
  task: TaskNode | null = null;

  @State newChecklistItemText: string = '';

  onUpdateTask: (task: TaskNode) => void = () => {};
  onDeleteTask: (id: string) => void = () => {};
  onBack: () => void = () => {};
  onStartConnecting: () => void = () => {};
  onUpdateChecklist: (taskId: string, checklist: ChecklistItem[]) => void = () => {};
  onAddChecklistItem: (taskId: string, text: string) => void = () => {};

  private getDuration(): number {
    if (!this.task) return 0;
    const diffTime = this.task.endDate.getTime() - this.task.startDate.getTime();
    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
    return Math.max(1, diffDays);
  }

  // å°è£…ä¸€ä¸ªç»Ÿä¸€çš„æ·»åŠ å‡½æ•°
  private submitNewChecklistItem() {
    if (this.task && this.newChecklistItemText.trim() !== '') {
      // éªŒè¯æ¸…å•é¡¹
      const validation = ValidationUtils.validateChecklistItem(this.newChecklistItemText);
      if (!validation.isValid) {
        promptAction.showToast({ message: validation.message });
        return;
      }
      
      this.onAddChecklistItem(this.task.id, this.newChecklistItemText);
      this.newChecklistItemText = '';
    }
  }

  build() {
    if (this.task) {
      // FIX: å°†æ ¹å¸ƒå±€æ”¹ä¸ºScrollï¼Œä»¥ç¡®ä¿æ•´ä¸ªç¼–è¾‘å™¨åœ¨å†…å®¹æº¢å‡ºæ—¶å¯ä»¥æ»šåŠ¨
      Scroll() {
        Column({ space: 20 }) {
          // --- å¤´éƒ¨ä¿¡æ¯å¡ç‰‡ ---
          Column({ space: 16 }) {
            // æ ‡é¢˜åŒºåŸŸ
            Row({ space: 12 }) {
              Text('ðŸ“')
                .fontSize(24)
                .fontColor('#007DFF')
              Text('ç¼–è¾‘ä»»åŠ¡')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1F2937')
                .layoutWeight(1)
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)

            // ä»»åŠ¡åç§°è¾“å…¥
            Column({ space: 8 }) {
              Text('ä»»åŠ¡åç§°')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#374151')
              TextInput({ text: this.task?.name || '' })
                .backgroundColor('#F9FAFB')
                .borderRadius(8)
                .padding(12)
                .fontSize(16)
                .onChange((value: string) => {
                  if (this.task) {
                    // éªŒè¯ä»»åŠ¡åç§°
                    const validation = ValidationUtils.validateProjectName(value);
                    if (!validation.isValid) {
                      promptAction.showToast({ message: validation.message });
                      return;
                    }
                    
                    const updatedTask: TaskNode = {
                      id: this.task.id,
                      name: value,
                      startDate: this.task.startDate,
                      endDate: this.task.endDate,
                      checklist: this.task.checklist,
                      x: this.task.x,
                      y: this.task.y,
                      isCritical: this.task.isCritical,
                      earlyStart: this.task.earlyStart,
                      earlyFinish: this.task.earlyFinish,
                      lateStart: this.task.lateStart,
                      lateFinish: this.task.lateFinish
                    };
                    this.onUpdateTask(updatedTask);
                  }
                })
            }

            // æ—¥æœŸé€‰æ‹©åŒºåŸŸ
            Row({ space: 12 }) {
              Column({ space: 8 }) {
                Text('å¼€å§‹æ—¥æœŸ')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#374151')
                DatePicker({
                  start: new Date('2020-01-01'),
                  end: new Date('2030-12-31'),
                  selected: this.task?.startDate || new Date()
                })
                  .backgroundColor('#F9FAFB')
                  .borderRadius(8)
                  .padding(12)
                  .border({ width: 1, color: '#E5E7EB', radius: 8 })
                  .onDateChange((value: Date) => {
                    if (this.task) {
                      const newStartDate = value;
                      const newEndDate = this.task.endDate < newStartDate ? newStartDate : this.task.endDate;
                      const updatedTask: TaskNode = {
                        id: this.task.id,
                        name: this.task.name,
                        startDate: newStartDate,
                        endDate: newEndDate,
                        checklist: this.task.checklist,
                        x: this.task.x,
                        y: this.task.y,
                        isCritical: this.task.isCritical,
                        earlyStart: this.task.earlyStart,
                        earlyFinish: this.task.earlyFinish,
                        lateStart: this.task.lateStart,
                        lateFinish: this.task.lateFinish
                      };
                      this.onUpdateTask(updatedTask);
                    }
                  })
              }.layoutWeight(1)

              Column({ space: 8 }) {
                Text('ç»“æŸæ—¥æœŸ')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#374151')
                DatePicker({
                  start: new Date('2020-01-01'),
                  end: new Date('2030-12-31'),
                  selected: this.task?.endDate || new Date()
                })
                  .backgroundColor('#F9FAFB')
                  .borderRadius(8)
                  .padding(12)
                  .border({ width: 1, color: '#E5E7EB', radius: 8 })
                  .onDateChange((value: Date) => {
                    if (this.task) {
                      const newEndDate = value;
                      const newStartDate = this.task.startDate > newEndDate ? newEndDate : this.task.startDate;
                      const updatedTask: TaskNode = {
                        id: this.task.id,
                        name: this.task.name,
                        startDate: newStartDate,
                        endDate: newEndDate,
                        checklist: this.task.checklist,
                        x: this.task.x,
                        y: this.task.y,
                        isCritical: this.task.isCritical,
                        earlyStart: this.task.earlyStart,
                        earlyFinish: this.task.earlyFinish,
                        lateStart: this.task.lateStart,
                        lateFinish: this.task.lateFinish
                      };
                      this.onUpdateTask(updatedTask);
                    }
                  })
              }.layoutWeight(1)
            }

            // å·¥æœŸæ˜¾ç¤º
            Row({ space: 8 }) {
              Text('â±ï¸')
                .fontSize(16)
                .fontColor('#6B7280')
              Text(`å·¥æœŸ: ${this.getDuration()} å¤©`)
                .fontSize(14)
                .fontColor('#6B7280')
                .fontWeight(FontWeight.Medium)
            }
            .width('100%')
            .justifyContent(FlexAlign.End)
          }
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({ radius: 8, color: '#0000000A', offsetX: 0, offsetY: 2 })

          // --- ä»»åŠ¡æ¸…å•å¡ç‰‡ ---
          Column({ space: 16 }) {
            // æ¸…å•æ ‡é¢˜
            Row({ space: 8 }) {
              Text('ðŸ“‹')
                .fontSize(18)
                .fontColor('#007DFF')
              Text('ä»»åŠ¡æ¸…å•')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1F2937')
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)

            // æ·»åŠ æ–°å­ä»»åŠ¡
            Row({ space: 12 }) {
              TextInput({ placeholder: 'æ·»åŠ ä¸€ä¸ªå­ä»»åŠ¡...', text: this.newChecklistItemText })
                .layoutWeight(1)
                .backgroundColor('#F9FAFB')
                .borderRadius(8)
                .padding(12)
                .fontSize(14)
                .onChange((value: string) => {
                  this.newChecklistItemText = value;
                })
                .onSubmit(() => {
                  this.submitNewChecklistItem();
                })
              Button() {
                Text('+')
                  .fontSize(18)
                  .fontColor(Color.White)
                  .fontWeight(FontWeight.Bold)
              }
              .width(44)
              .height(44)
              .backgroundColor('#007DFF')
              .borderRadius(8)
              .shadow({ radius: 4, color: '#007DFF30', offsetX: 0, offsetY: 2 })
              .onClick(() => {
                this.submitNewChecklistItem();
              })
            }

            // å­ä»»åŠ¡åˆ—è¡¨
            if (!this.task || this.task.checklist.length === 0) {
              Column({ space: 8 }) {
                Image($r('app.media.ic_empty_box'))
                  .width(40)
                  .height(40)
                  .opacity(0.5)
                Text('æš‚æ— å­ä»»åŠ¡')
                  .fontSize(14)
                  .fontColor('#9CA3AF')
              }
              .width('100%')
              .padding(20)
              .justifyContent(FlexAlign.Center)
            } else if (this.task) {
              Column({ space: 8 }) {
                ForEach(this.task.checklist, (item: ChecklistItem) => {
                  Row({ space: 12 }) {
                    Checkbox({ name: item.id, group: 'checklist' })
                      .select(item.isCompleted)
                      .onChange((value: boolean) => {
                        if (this.task) {
                          const newChecklist = this.task.checklist.map(i => {
                            if (i.id === item.id) {
                              return {
                                id: i.id,
                                text: i.text,
                                isCompleted: value
                              };
                            }
                            return i;
                          });
                          this.onUpdateChecklist(this.task.id, newChecklist);
                        }
                      })
                    Text(item.text)
                      .fontSize(14)
                      .fontColor(item.isCompleted ? '#9CA3AF' : '#374151')
                      .decoration({ type: item.isCompleted ? TextDecorationType.LineThrough : TextDecorationType.None })
                      .layoutWeight(1)
                      .textAlign(TextAlign.Start)
                  }
                  .width('100%')
                  .padding(12)
                  .backgroundColor(item.isCompleted ? '#F9FAFB' : '#FFFFFF')
                  .borderRadius(8)
                  .border({ width: 1, color: item.isCompleted ? '#E5E7EB' : '#D1D5DB', radius: 8 })
                }, (item: ChecklistItem) => item.id)
              }
            }
          }
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({ radius: 8, color: '#0000000A', offsetX: 0, offsetY: 2 })

          // --- åº•éƒ¨æ“ä½œæŒ‰é’® ---
          Column({ space: 12 }) {
            CommonButton({
              text: 'åˆ›å»ºä¾èµ–ä»Žæ­¤ä»»åŠ¡å¼€å§‹',
              icon: 'ðŸ”—',
              type: 'primary',
              onButtonClick: () => { this.onStartConnecting() }
            })

            CommonButton({
              text: 'åˆ é™¤æ­¤ä»»åŠ¡',
              icon: 'ðŸ—‘ï¸',
              type: 'danger',
              onButtonClick: () => {
                if (this.task) {
                  // æ·»åŠ åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
                  AlertDialog.show({
                    title: 'ç¡®è®¤åˆ é™¤ä»»åŠ¡',
                    message: `ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${this.task.name}"å—ï¼Ÿåˆ é™¤åŽæ— æ³•æ¢å¤ã€‚`,
                    primaryButton: {
                      value: 'å–æ¶ˆ',
                      action: () => {
                        // å–æ¶ˆåˆ é™¤
                      }
                    },
                    secondaryButton: {
                      value: 'åˆ é™¤',
                      fontColor: '#EF4444',
                      action: () => {
                        if (this.task) {
                          this.onDeleteTask(this.task.id);
                        }
                      }
                    }
                  });
                }
              }
            })

            CommonButton({
              text: 'è¿”å›žåˆ—è¡¨',
              icon: 'â†',
              type: 'secondary',
              onButtonClick: () => { this.onBack() }
            })
          }
        }
        .padding(20)
      }
    }
  }
}
