// File: entry/src/main/ets/components/Sidebar.ets

import { Project, TaskNode, ChecklistItem } from '../model/ProjectData';
import { TaskEditor } from './TaskEditor';
import promptAction from '@ohos.promptAction';

@Component
export struct Sidebar {
  // projectçŽ°åœ¨å¯èƒ½ä¸ºnullï¼Œç›´åˆ°å®ƒè¢«åŠ è½½
  @ObjectLink project: Project | null;
  @Link selectedTask: TaskNode | null;

  @State isEditingProjectName: boolean = false;
  @State tempProjectName: string = '';

  onUpdateTask: (task: TaskNode) => void = () => {};
  onUpdateChecklist: (taskId: string, checklist: ChecklistItem[]) => void = () => {};
  onAddChecklistItem: (taskId: string, text: string) => void = () => {};
  onUpdateProjectName: (newName: string) => void = () => {};
  onAddTask: () => void = () => {};
  onDeleteTask: (id: string) => void = () => {};
  onStartConnecting: () => void = () => {};
  onCalculate: () => void = () => {};
  // æ–°å¢žå›žè°ƒ
  onSave: () => void = () => {};
  onBack: () => void = () => {};

  private saveProjectName() {
    if (this.tempProjectName.trim() === '') {
      promptAction.showToast({ message: 'é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©º' });
      return;
    }
    this.onUpdateProjectName(this.tempProjectName);
    this.isEditingProjectName = false;
  }

  build() {
    Column() {
      // åªæœ‰å½“é¡¹ç›®åŠ è½½å®ŒæˆåŽæ‰æ˜¾ç¤ºå†…å®¹
      if (this.project) {
        if (this.selectedTask === null) {
          this.ProjectView()
        } else {
          TaskEditor({
            task: this.selectedTask,
            onUpdateTask: this.onUpdateTask,
            onUpdateChecklist: this.onUpdateChecklist,
            onAddChecklistItem: this.onAddChecklistItem,
            onDeleteTask: this.onDeleteTask,
            onStartConnecting: this.onStartConnecting,
            onBack: () => {
              this.selectedTask = null;
            }
          })
        }
      } else {
        // é¡¹ç›®åŠ è½½ä¸­æˆ–åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºçš„å†…å®¹
        Column() {
          Text('æ­£åœ¨åŠ è½½é¡¹ç›®...')
            .fontSize(18)
            .fontColor(Color.Gray)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F3F4F6')
    .padding(15)
  }

  @Builder
  ProjectView() {
    if (this.project) {
      Column({ space: 10 }) {
        // --- é¡¶éƒ¨æ“ä½œæ  ---
        Row({space: 10}) {
          // è¿”å›žä¸»é¡µæŒ‰é’®
          Button() { Image($r('app.media.ic_back')).width(20).height(20) }
          .width(40).height(40).type(ButtonType.Circle).backgroundColor(Color.White)
          .onClick(() => { this.onBack() })

          // FIX: The Button component with children cannot have a label parameter.
          // The text is now a Text component inside the button's child Row.
          Button({ type: ButtonType.Capsule }) {
            Row({ space: 8 }) {
              Image($r('app.media.ic_save')).width(20).height(20).fillColor(Color.White)
              Text('ä¿å­˜é¡¹ç›®').fontSize(16).fontColor(Color.White)
            }
          }
          .layoutWeight(1).backgroundColor('#007DFF')
          .onClick(() => { this.onSave() })
        }
        .width('100%')

        Divider().margin({ top: 10, bottom: 10 })

        // å¯ç¼–è¾‘çš„é¡¹ç›®æ ‡é¢˜
        Row({ space: 8 }) {
          if (this.isEditingProjectName) {
            TextInput({ text: this.tempProjectName })
              .layoutWeight(1).fontSize(24).fontWeight(FontWeight.Bold)
              .onChange((value: string) => { this.tempProjectName = value; })
              .onSubmit(() => { this.saveProjectName(); })
          } else {
            Text(this.project.name)
              .fontSize(24).fontWeight(FontWeight.Bold).layoutWeight(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis }).maxLines(1)
          }
          Button() { Image(this.isEditingProjectName ? $r('app.media.ic_confirm') : $r('app.media.ic_edit')).width(20).height(20).fillColor(Color.Black) }
          .width(40).height(40).type(ButtonType.Circle).backgroundColor('#EFEFEF')
          .onClick(() => {
            if (this.isEditingProjectName) {
              this.saveProjectName();
            } else {
              this.tempProjectName = this.project!.name;
              this.isEditingProjectName = true;
            }
          })
        }.width('100%').alignItems(VerticalAlign.Center).margin({ bottom: 5 })

        // é¡¹ç›®ç»Ÿè®¡
        Text(`æ€»ä»»åŠ¡æ•°: ${this.project.tasks.length}`).fontSize(12).fontColor(Color.Gray).width('100%').margin({ bottom: 10 })

        // æ“ä½œæŒ‰é’®
        Button('ï¼‹ æ·»åŠ æ–°ä»»åŠ¡')
          .width('100%').height(45).type(ButtonType.Normal).backgroundColor('#007DFF')
          .fontColor(Color.White)
          .onClick(() => { this.onAddTask() })
        Button('ðŸ’¡ è®¡ç®—å…³é”®è·¯å¾„')
          .width('100%').height(45).type(ButtonType.Normal).backgroundColor('#28A745')
          .fontColor(Color.White)
          .margin({ top: 10 })
          .onClick(() => { this.onCalculate() })

        Divider().margin({ top: 15, bottom: 5 })

        // ä»»åŠ¡åˆ—è¡¨
        if (this.project.tasks.length === 0) {
          Column() { Text('ç‚¹å‡»"æ·»åŠ æ–°ä»»åŠ¡"å¼€å§‹').fontColor(Color.Gray) }.justifyContent(FlexAlign.Center).layoutWeight(1)
        } else {
          List({ space: 8 }) {
            ForEach(this.project.tasks.sort((a, b) => a.startDate.getTime() - b.startDate.getTime()), (task: TaskNode) => {
              ListItem() {
                Row({ space: 12 }) {
                  Column().width(5).height(30).backgroundColor(task.isCritical ? '#D0021B' : '#007DFF').borderRadius(5)
                  Column({ space: 4 }) {
                    Text(task.name).fontSize(16).fontWeight(FontWeight.Medium)
                    Text(`èµ·æ­¢: ${task.startDate.toLocaleDateString()}`).fontSize(12).fontColor(Color.Gray)
                  }.alignItems(HorizontalAlign.Start).layoutWeight(1)
                }
                .width('100%').padding(12).backgroundColor(this.selectedTask?.id === task.id ? '#E0EFFF' : Color.White).borderRadius(8)
                .border({ width: this.selectedTask?.id === task.id ? 2 : 0, color: '#007DFF', radius: 8 })
                .onClick(() => { 
                  this.selectedTask = task; 
                })
              }
            })
          }.layoutWeight(1)
        }
      }.alignItems(HorizontalAlign.Start)
    }
  }
}
