// File: entry/src/main/ets/components/SearchView.ets

import { SearchService, SearchResult, SearchOptions } from '../services/SearchService';
import { CommonButton } from './CommonButton';
import { ThemeConfig } from '../utils/ThemeConfig';
import { ProjectMeta } from '../services/StorageService';
import { TaskNode } from '../model/ProjectData';
import { LoadingView } from './LoadingView';

@Component
export struct SearchView {
  @State searchKeyword: string = '';
  @State searchResults: SearchResult[] = [];
  @State isSearching: boolean = false;
  @State showFilters: boolean = false;
  @State includeCompleted: boolean = true;
  @State includeIncomplete: boolean = true;
  @State popularKeywords: string[] = [];
  @State searchSuggestions: string[] = [];

  onProjectSelect: (projectId: string) => void = () => {};
  onClose: () => void = () => {};

  private searchService: SearchService = SearchService.getInstance();

  async aboutToAppear() {
    await this.loadPopularKeywords();
  }

  async loadPopularKeywords() {
    try {
      this.popularKeywords = await this.searchService.getPopularKeywords();
    } catch (error) {
      console.error('åŠ è½½çƒ­é—¨å…³é”®è¯å¤±è´¥:', error);
    }
  }

  async performSearch() {
    if (!this.searchKeyword.trim()) {
      this.searchResults = [];
      return;
    }

    this.isSearching = true;
    try {
      const options: SearchOptions = {
        keyword: this.searchKeyword,
        includeCompleted: this.includeCompleted,
        includeIncomplete: this.includeIncomplete
      };

      this.searchResults = await this.searchService.searchProjects(options);
    } catch (error) {
      console.error('æœç´¢å¤±è´¥:', error);
    } finally {
      this.isSearching = false;
    }
  }

  async getSuggestions(keyword: string) {
    if (keyword.length < 1) {
      this.searchSuggestions = [];
      return;
    }

    try {
      this.searchSuggestions = await this.searchService.getSearchSuggestions(keyword);
    } catch (error) {
      console.error('è·å–æœç´¢å»ºè®®å¤±è´¥:', error);
    }
  }

  build() {
    Column() {
      // æœç´¢å¤´éƒ¨
      this.SearchHeader()

      // æœç´¢è¿‡æ»¤å™¨
      if (this.showFilters) {
        this.SearchFilters()
      }

      // æœç´¢å»ºè®®
      if (this.searchSuggestions.length > 0 && this.searchKeyword) {
        this.SearchSuggestions()
      }

      // çƒ­é—¨å…³é”®è¯
      if (this.popularKeywords.length > 0 && !this.searchKeyword) {
        this.PopularKeywords()
      }

      // æœç´¢ç»“æœ
      if (this.searchResults.length > 0) {
        this.SearchResults()
      } else if (this.searchKeyword && !this.isSearching) {
        this.EmptyResults()
      }

      // åŠ è½½çŠ¶æ€
      if (this.isSearching) {
        this.LoadingState()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeConfig.white)
  }

  @Builder
  SearchHeader() {
    Row({ space: ThemeConfig.spacingM }) {
      // è¿”å›æŒ‰é’®
      Button({ type: ButtonType.Circle }) {
        Image($r('app.media.ic_back'))
          .width(20)
          .height(20)
          .fillColor(ThemeConfig.gray600)
      }
      .width(40)
      .height(40)
      .backgroundColor(ThemeConfig.gray100)
      .onClick(() => {
        this.onClose();
      })

      // æœç´¢è¾“å…¥æ¡†
      TextInput({ 
        placeholder: 'æœç´¢é¡¹ç›®ã€ä»»åŠ¡æˆ–æ£€æŸ¥æ¸…å•...',
        text: this.searchKeyword 
      })
        .backgroundColor(ThemeConfig.gray50)
        .borderRadius(ThemeConfig.radiusMedium)
        .padding(ThemeConfig.spacingM)
        .layoutWeight(1)
        .onChange((value: string) => {
          this.searchKeyword = value;
          this.getSuggestions(value);
        })
        .onSubmit(() => {
          this.performSearch();
        })

      // è¿‡æ»¤å™¨æŒ‰é’®
      Button({ type: ButtonType.Circle }) {
        Image($r('app.media.ic_select'))
          .width(20)
          .height(20)
          .fillColor(this.showFilters ? ThemeConfig.primaryColor : ThemeConfig.gray600)
      }
      .width(40)
      .height(40)
      .backgroundColor(this.showFilters ? ThemeConfig.primaryLight : ThemeConfig.gray100)
      .onClick(() => {
        this.showFilters = !this.showFilters;
      })

      // æœç´¢æŒ‰é’®
      Button({ type: ButtonType.Circle }) {
        Image($r('app.media.ic_calculate'))
          .width(20)
          .height(20)
          .fillColor(Color.White)
      }
      .width(40)
      .height(40)
      .backgroundColor(ThemeConfig.primaryColor)
      .onClick(() => {
        this.performSearch();
      })
    }
    .width('100%')
    .padding(ThemeConfig.spacingL)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  SearchFilters() {
    Column({ space: ThemeConfig.spacingM }) {
      Text('æœç´¢è¿‡æ»¤å™¨')
        .fontSize(ThemeConfig.fontSizeM)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeConfig.gray800)

      Row({ space: ThemeConfig.spacingM }) {
        Toggle({ type: ToggleType.Checkbox, isOn: this.includeCompleted })
          .onChange((isOn: boolean) => {
            this.includeCompleted = isOn;
          })
        Text('åŒ…å«å·²å®Œæˆ')
          .fontSize(ThemeConfig.fontSizeS)
          .fontColor(ThemeConfig.gray700)
      }
      .alignItems(VerticalAlign.Center)

      Row({ space: ThemeConfig.spacingM }) {
        Toggle({ type: ToggleType.Checkbox, isOn: this.includeIncomplete })
          .onChange((isOn: boolean) => {
            this.includeIncomplete = isOn;
          })
        Text('åŒ…å«æœªå®Œæˆ')
          .fontSize(ThemeConfig.fontSizeS)
          .fontColor(ThemeConfig.gray700)
      }
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .padding(ThemeConfig.spacingL)
    .backgroundColor(ThemeConfig.gray50)
    .borderRadius(ThemeConfig.radiusMedium)
    .margin({ left: ThemeConfig.spacingL, right: ThemeConfig.spacingL })
  }

  @Builder
  SearchSuggestions() {
    Column({ space: ThemeConfig.spacingS }) {
      Text('æœç´¢å»ºè®®')
        .fontSize(ThemeConfig.fontSizeS)
        .fontColor(ThemeConfig.gray600)
        .margin({ left: ThemeConfig.spacingL })

      ForEach(this.searchSuggestions, (suggestion: string) => {
        Row() {
          Text(suggestion)
            .fontSize(ThemeConfig.fontSizeM)
            .fontColor(ThemeConfig.gray800)
            .layoutWeight(1)
        }
        .width('100%')
        .padding(ThemeConfig.spacingM)
        .backgroundColor(ThemeConfig.white)
        .onClick(() => {
          this.searchKeyword = suggestion;
          this.searchSuggestions = [];
          this.performSearch();
        })
      })
    }
    .margin({ top: ThemeConfig.spacingS })
  }

  @Builder
  PopularKeywords() {
    Column({ space: ThemeConfig.spacingM }) {
      Text('çƒ­é—¨æœç´¢')
        .fontSize(ThemeConfig.fontSizeM)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeConfig.gray800)
        .margin({ left: ThemeConfig.spacingL })

      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
        ForEach(this.popularKeywords, (keyword: string) => {
          Button() {
            Text(keyword)
              .fontSize(ThemeConfig.fontSizeS)
              .fontColor(ThemeConfig.primaryColor)
          }
          .height(28)
          .backgroundColor(ThemeConfig.primaryLight)
          .borderRadius(ThemeConfig.radiusSmall)
          .margin({ right: ThemeConfig.spacingS, bottom: ThemeConfig.spacingS })
          .onClick(() => {
            this.searchKeyword = keyword;
            this.performSearch();
          })
        })
      }
      .padding(ThemeConfig.spacingL)
    }
  }

  @Builder
  SearchResults() {
    List({ space: ThemeConfig.spacingM }) {
      ForEach(this.searchResults, (result: SearchResult) => {
        ListItem() {
          this.SearchResultCard(result)
        }
      })
    }
    .padding(ThemeConfig.spacingL)
  }

  @Builder
  SearchResultCard(result: SearchResult) {
    Column({ space: ThemeConfig.spacingS }) {
      // é¡¹ç›®ä¿¡æ¯
      Row({ space: ThemeConfig.spacingM }) {
        Text('ğŸ“')
          .fontSize(ThemeConfig.fontSizeL)
          .fontColor(ThemeConfig.primaryColor)
        
        Column({ space: ThemeConfig.spacingXS }) {
          Text(result.project.name)
            .fontSize(ThemeConfig.fontSizeM)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeConfig.gray800)
          
          Text(`ç›¸å…³æ€§: ${result.relevanceScore}`)
            .fontSize(ThemeConfig.fontSizeXS)
            .fontColor(ThemeConfig.gray500)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        Button() {
          Text('æŸ¥çœ‹')
            .fontSize(ThemeConfig.fontSizeS)
            .fontColor(Color.White)
        }
        .height(28)
        .backgroundColor(ThemeConfig.primaryColor)
        .borderRadius(ThemeConfig.radiusSmall)
        .onClick(() => {
          this.onProjectSelect(result.project.id);
        })
      }

      // åŒ¹é…çš„ä»»åŠ¡
      if (result.matchedTasks.length > 0) {
        Column({ space: ThemeConfig.spacingXS }) {
          Text(`åŒ¹é…çš„ä»»åŠ¡ (${result.matchedTasks.length})`)
            .fontSize(ThemeConfig.fontSizeS)
            .fontColor(ThemeConfig.gray600)
            .margin({ top: ThemeConfig.spacingS })

          ForEach(result.matchedTasks, (task: TaskNode) => {
            Row({ space: ThemeConfig.spacingS }) {
              Text('â€¢')
                .fontSize(ThemeConfig.fontSizeS)
                .fontColor(ThemeConfig.gray500)
              
              Text(task.name)
                .fontSize(ThemeConfig.fontSizeS)
                .fontColor(ThemeConfig.gray700)
                .layoutWeight(1)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
              
              Text(task.checklist.every(item => item.isCompleted) ? 'âœ…' : 'â³')
                .fontSize(ThemeConfig.fontSizeS)
                .fontColor(ThemeConfig.gray500)
            }
            .width('100%')
            .padding({ left: ThemeConfig.spacingM })
          })
        }
      }
    }
    .width('100%')
    .padding(ThemeConfig.spacingM)
    .backgroundColor(ThemeConfig.white)
    .borderRadius(ThemeConfig.radiusMedium)
    .border({ width: 1, color: ThemeConfig.gray200, radius: ThemeConfig.radiusMedium })
  }

  @Builder
  EmptyResults() {
    Column({ space: ThemeConfig.spacingM }) {
      Image($r('app.media.ic_empty_box'))
        .width(80)
        .height(80)
        .opacity(0.6)
      
      Text('æœªæ‰¾åˆ°ç›¸å…³ç»“æœ')
        .fontSize(ThemeConfig.fontSizeL)
        .fontColor(ThemeConfig.gray600)
        .fontWeight(FontWeight.Medium)
      
      Text('å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯æˆ–è°ƒæ•´æœç´¢æ¡ä»¶')
        .fontSize(ThemeConfig.fontSizeS)
        .fontColor(ThemeConfig.gray500)
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  LoadingState() {
    Column({ space: ThemeConfig.spacingM }) {
      LoadingView({ message: 'æœç´¢ä¸­...' })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
} 