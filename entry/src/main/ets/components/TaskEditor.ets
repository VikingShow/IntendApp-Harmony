// File: entry/src/main/ets/components/TaskEditor.ets

import { TaskNode, ChecklistItem } from '../model/ProjectData';

@Component
export struct TaskEditor {
  task: TaskNode | null = null;

  @State newChecklistItemText: string = '';

  onUpdateTask: (task: TaskNode) => void = () => {};
  onDeleteTask: (id: string) => void = () => {};
  onBack: () => void = () => {};
  onStartConnecting: () => void = () => {};
  onUpdateChecklist: (taskId: string, checklist: ChecklistItem[]) => void = () => {};
  onAddChecklistItem: (taskId: string, text: string) => void = () => {};

  private getDuration(): number {
    if (!this.task) return 0;
    const diffTime = this.task.endDate.getTime() - this.task.startDate.getTime();
    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
    return Math.max(1, diffDays);
  }

  // å°è£…ä¸€ä¸ªç»Ÿä¸€çš„æ·»åŠ å‡½æ•°
  private submitNewChecklistItem() {
    if (this.task && this.newChecklistItemText.trim() !== '') {
      this.onAddChecklistItem(this.task.id, this.newChecklistItemText);
      this.newChecklistItemText = '';
    }
  }

  build() {
    if (this.task) {
      // FIX: å°†æ ¹å¸ƒå±€æ”¹ä¸ºScrollï¼Œä»¥ç¡®ä¿æ•´ä¸ªç¼–è¾‘å™¨åœ¨å†…å®¹æº¢å‡ºæ—¶å¯ä»¥æ»šåŠ¨
      Scroll() {
        Column({ space: 15 }) {
          // --- å¤´éƒ¨ä¿¡æ¯ ---
          Column({ space: 10 }) {
            Text(`ç¼–è¾‘: ${this.task.name}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .width('100%')
              .textAlign(TextAlign.Start)

            TextInput({ text: this.task.name })
              .onChange((value: string) => {
                if (this.task) {
                  const updatedTask: TaskNode = {
                    id: this.task.id,
                    name: value,
                    startDate: this.task.startDate,
                    endDate: this.task.endDate,
                    checklist: this.task.checklist,
                    x: this.task.x,
                    y: this.task.y,
                    isCritical: this.task.isCritical,
                    earlyStart: this.task.earlyStart,
                    earlyFinish: this.task.earlyFinish,
                    lateStart: this.task.lateStart,
                    lateFinish: this.task.lateFinish
                  };
                  this.onUpdateTask(updatedTask);
                }
              })

            Row({ space: 10 }) {
              Column() {
                Text('å¼€å§‹æ—¥æœŸ').fontSize(14).fontColor(Color.Gray)
                DatePicker({
                  start: new Date('2020-01-01'),
                  end: new Date('2030-12-31'),
                  selected: this.task.startDate
                })
                  .onDateChange((value: Date) => {
                    if (this.task) {
                      const newStartDate = value;
                      const newEndDate = this.task.endDate < newStartDate ? newStartDate : this.task.endDate;
                      const updatedTask: TaskNode = {
                        id: this.task.id,
                        name: this.task.name,
                        startDate: newStartDate,
                        endDate: newEndDate,
                        checklist: this.task.checklist,
                        x: this.task.x,
                        y: this.task.y,
                        isCritical: this.task.isCritical,
                        earlyStart: this.task.earlyStart,
                        earlyFinish: this.task.earlyFinish,
                        lateStart: this.task.lateStart,
                        lateFinish: this.task.lateFinish
                      };
                      this.onUpdateTask(updatedTask);
                    }
                  })
              }.layoutWeight(1)

              Column() {
                Text('ç»“æŸæ—¥æœŸ').fontSize(14).fontColor(Color.Gray)
                DatePicker({
                  start: new Date('2020-01-01'),
                  end: new Date('2030-12-31'),
                  selected: this.task.endDate
                })
                  .onDateChange((value: Date) => {
                    if (this.task) {
                      const newEndDate = value;
                      const newStartDate = this.task.startDate > newEndDate ? newEndDate : this.task.startDate;
                      const updatedTask: TaskNode = {
                        id: this.task.id,
                        name: this.task.name,
                        startDate: newStartDate,
                        endDate: newEndDate,
                        checklist: this.task.checklist,
                        x: this.task.x,
                        y: this.task.y,
                        isCritical: this.task.isCritical,
                        earlyStart: this.task.earlyStart,
                        earlyFinish: this.task.earlyFinish,
                        lateStart: this.task.lateStart,
                        lateFinish: this.task.lateFinish
                      };
                      this.onUpdateTask(updatedTask);
                    }
                  })
              }.layoutWeight(1)
            }

            Text(`å·¥æœŸ: ${this.getDuration()} å¤©`)
              .fontSize(12)
              .fontColor(Color.Gray)
              .width('100%')
              .textAlign(TextAlign.End)
          }

          Divider().margin({ top: 10, bottom: 10 })

          // --- ä»»åŠ¡æ¸…å• ---
          Text('ä»»åŠ¡æ¸…å•')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .width('100%')

          Row({ space: 8 }) {
            TextInput({ placeholder: 'æ·»åŠ ä¸€ä¸ªå­ä»»åŠ¡...', text: this.newChecklistItemText })
              .layoutWeight(1)
              .onChange((value: string) => {
                this.newChecklistItemText = value;
              })
              .onSubmit(() => {
                this.submitNewChecklistItem();
              })
            Button('+')
              .width(40).height(40)
              .onClick(() => {
                this.submitNewChecklistItem();
              })
          }.margin({ bottom: 10 })

          // å­ä»»åŠ¡åˆ—è¡¨
          Column({ space: 5 }) {
            // FIX: ä¸ºForEachå¢åŠ keyç”Ÿæˆå™¨ï¼Œç¡®ä¿åˆ—è¡¨èƒ½å¯é æ›´æ–°
            ForEach(this.task.checklist, (item: ChecklistItem) => {
              Row({ space: 10 }) {
                Checkbox({ name: item.id, group: 'checklist' })
                  .select(item.isCompleted)
                  .onChange((value: boolean) => {
                    if (this.task) {
                      const newChecklist = this.task.checklist.map(i => {
                        if (i.id === item.id) {
                          return {
                            id: i.id,
                            text: i.text,
                            isCompleted: value
                          };
                        }
                        return i;
                      });
                      this.onUpdateChecklist(this.task.id, newChecklist);
                    }
                  })
                Text(item.text)
                  .fontColor(item.isCompleted ? Color.Gray : Color.Black)
                  .decoration({ type: item.isCompleted ? TextDecorationType.LineThrough : TextDecorationType.None })
              }
              .padding({ top: 5, bottom: 5 })
            }, (item: ChecklistItem) => item.id) // keyç”Ÿæˆå™¨
          }
          .alignItems(HorizontalAlign.Start)
          .width('100%')


          // --- åº•éƒ¨æ“ä½œæŒ‰é’® ---
          Column({ space: 10 }) {
            Button('ğŸ”— åˆ›å»ºä¾èµ–ä»æ­¤ä»»åŠ¡å¼€å§‹')
              .width('100%')
              .type(ButtonType.Normal)
              .onClick(() => { this.onStartConnecting() })

            Button('åˆ é™¤æ­¤ä»»åŠ¡')
              .width('100%')
              .type(ButtonType.Capsule)
              .backgroundColor(Color.Red)
              .onClick(() => {
                if (this.task) {
                  this.onDeleteTask(this.task.id);
                }
              })

            Button('è¿”å›åˆ—è¡¨')
              .width('100%')
              .type(ButtonType.Normal)
              .onClick(() => { this.onBack() })
          }.margin({ top: 20 })
        }
        .padding({ bottom: 20 }) // ä¸ºæ»šåŠ¨å†…å®¹å¢åŠ åº•éƒ¨å†…è¾¹è·
      }
    }
  }
}
