// File: entry/src/main/ets/components/DashboardView.ets
import { Project, TaskNode } from '../model/ProjectData';
import router from '@ohos.router';

@Component
export struct DashboardView {
  // æ¥æ”¶ä»HomePageä¼ é€’è¿‡æ¥çš„å®Œæ•´é¡¹ç›®æ•°æ®
  @ObjectLink project: Project;

  // aboutToAppear ä¼šåœ¨ç»„ä»¶é¦–æ¬¡åˆ›å»ºå’Œæ˜¾ç¤ºæ—¶è°ƒç”¨
  aboutToAppear() {
    console.log(`[DashboardView] Component appeared for project: ${this.project.name} with ${this.project.tasks.length} tasks`);
  }

  // aboutToUpdate ä¼šåœ¨ @ObjectLink project çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶è°ƒç”¨
  aboutToUpdate() {
    console.log(`[DashboardView] Project data updated: ${this.project.name} with ${this.project.tasks.length} tasks`);
  }




  // --- Helper Functions to calculate stats ---
  private getDuration(task: TaskNode): number {
    const diffTime = task.endDate.getTime() - task.startDate.getTime();
    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
    return Math.max(1, diffDays);
  }

  private getTotalDuration(): number {
    if (!this.project || this.project.tasks.length === 0) return 0;
    const startDates = this.project.tasks.map(t => t.startDate.getTime());
    const endDates = this.project.tasks.map(t => t.endDate.getTime());
    const minStart = Math.min(...startDates);
    const maxEnd = Math.max(...endDates);
    const diffTime = maxEnd - minStart;
    const duration = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
    console.log(`[DashboardView] Project "${this.project.name}" total duration: ${duration} days (from ${new Date(minStart).toLocaleDateString()} to ${new Date(maxEnd).toLocaleDateString()})`);
    return duration;
  }

  private getOverallCompletion(): number {
    if (!this.project || this.project.tasks.length === 0) return 0;
    const totalChecklistItems = this.project.tasks.reduce((sum, task) => sum + task.checklist.length, 0);
    if (totalChecklistItems === 0) return 0;
    const completedItems = this.project.tasks.reduce((sum, task) => {
      return sum + task.checklist.filter(item => item.isCompleted).length;
    }, 0);
    const completion = Math.round((completedItems / totalChecklistItems) * 100);
    console.log(`[DashboardView] Project "${this.project.name}" overall completion: ${completion}% (${completedItems}/${totalChecklistItems} checklist items completed)`);
    return completion;
  }

  private getCriticalTasksCount(): number {
    const count = this.project.tasks.filter(t => t.isCritical).length;
    console.log(`[DashboardView] Project "${this.project.name}" critical tasks count: ${count}/${this.project.tasks.length}`);
    return count;
  }

  private getUpcomingTasks(): TaskNode[] {
    const now = new Date();
    const sevenDaysLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    const upcoming = this.project.tasks
      .filter(task => task.endDate >= now && task.endDate <= sevenDaysLater)
      .sort((a, b) => a.endDate.getTime() - b.endDate.getTime());
    console.log(`[DashboardView] Project "${this.project.name}" upcoming tasks: ${upcoming.length} tasks in next 7 days`);
    return upcoming;
  }

  build() {
    // build() æ–¹æ³•ç°åœ¨æ˜¯çº¯ç²¹çš„UIæè¿°ï¼Œä¸å†åŒ…å«ä¸šåŠ¡é€»è¾‘è®¡ç®—
    Scroll() {
      Column({ space: 20 }) {
        // 1. é¡¹ç›®æ ‡é¢˜å’Œè¿›å…¥ç¼–è¾‘æŒ‰é’®
        Row() {
          Text(this.project.name)
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .maxLines(1)
            .fontColor('#1F2937')

          Button({ type: ButtonType.Capsule }) {
            Row({ space: 8 }) {
              Image($r('app.media.ic_edit'))
                .width(20)
                .height(20)
                .fillColor(Color.White)
              Text('è¿›å…¥ç¼–è¾‘')
                .fontSize(17)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Medium)
            }
          }
          .height(48)
          .backgroundColor('#007DFF')
          .shadow({ radius: 6, color: '#007DFF30', offsetX: 0, offsetY: 3 })
          .onClick(() => {
            router.pushUrl({
              url: 'pages/Index',
              params: { projectId: this.project.id }
            });
          })
        }
        .width('100%')

        // 2. æ ¸å¿ƒæŒ‡æ ‡ç»Ÿè®¡
        GridRow({
          columns: 4,
          gutter: { x: 16, y: 16 }
        }) {
          GridCol({ span: { xs: 4, sm: 2, md: 1 } }) {
            this.StatCard('ğŸ“‹ æ€»ä»»åŠ¡æ•°', `${this.project.tasks.length}ä¸ª`, '#EFF6FF', '#007DFF')
          }
          GridCol({ span: { xs: 4, sm: 2, md: 1 } }) {
            this.StatCard('â±ï¸ é¡¹ç›®æ€»å·¥æœŸ', `${this.getTotalDuration()}å¤©`, '#F0FDF4', '#16A34A')
          }
          GridCol({ span: { xs: 4, sm: 2, md: 1 } }) {
            this.StatCard('ğŸ“Š æ•´ä½“å®Œæˆåº¦', `${this.getOverallCompletion()}%`, '#FEF3C7', '#D97706')
          }
          GridCol({ span: { xs: 4, sm: 2, md: 1 } }) {
            this.StatCard('ğŸ”¥ å…³é”®ä»»åŠ¡æ•°', `${this.getCriticalTasksCount()}ä¸ª`, '#FEF2F2', '#DC2626')
          }
        }

        // è°ƒè¯•ä¿¡æ¯
        Text(`å½“å‰é¡¹ç›®: ${this.project.name} (ID: ${this.project.id})`)
          .fontSize(12)
          .fontColor('#6B7280')
          .width('100%')
          .textAlign(TextAlign.Center)
          .margin({ top: 8 })

        // 3. å³å°†åˆ°æœŸçš„ä»»åŠ¡åˆ—è¡¨
        Column({ space: 12 }) {
          Row({ space: 8 }) {
            Text('â°')
              .fontSize(20)
              .fontColor('#F59E0B')
            Text('å³å°†åˆ°æœŸçš„ä»»åŠ¡ (æœªæ¥7å¤©)')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1F2937')
          }
          .width('100%')
          .alignItems(VerticalAlign.Center)

          // ç›´æ¥è®¡ç®—å³å°†åˆ°æœŸçš„ä»»åŠ¡
          if (this.getUpcomingTasks().length > 0) {
            List({ space: 8 }) {
              ForEach(this.getUpcomingTasks(), (task: TaskNode) => {
                ListItem() {
                  this.UpcomingTaskCard(task)
                }
              })
            }
          } else {
            Column({ space: 8 }) {
              Image($r('app.media.ic_empty_box'))
                .width(40)
                .height(40)
                .opacity(0.5)
              Text('æœªæ¥7å¤©å†…æ²¡æœ‰åˆ°æœŸçš„ä»»åŠ¡')
                .fontSize(14)
                .fontColor('#9CA3AF')
            }
            .width('100%')
            .padding(24)
            .justifyContent(FlexAlign.Center)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .shadow({ radius: 4, color: '#00000008', offsetX: 0, offsetY: 1 })
          }
        }
        .alignItems(HorizontalAlign.Start)
      }
      .padding(30)
      .width('100%')
    }
  }

  // æ„å»ºå™¨ï¼šç»Ÿè®¡å¡ç‰‡
  @Builder
  StatCard(title: string, value: string, bgColor: string, textColor: string) {
    Column({ space: 8 }) {
      Text(title)
        .fontSize(14)
        .fontColor('#6B7280')
        .fontWeight(FontWeight.Medium)
      Text(value)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(textColor)
    }
    .width('100%')
    .padding(20)
    .backgroundColor(bgColor)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
    .shadow({ radius: 4, color: '#00000008', offsetX: 0, offsetY: 1 })
  }

  // æ„å»ºå™¨ï¼šå³å°†åˆ°æœŸçš„ä»»åŠ¡å¡ç‰‡
  @Builder
  UpcomingTaskCard(task: TaskNode) {
    Row({ space: 12 }) {
      // ä»»åŠ¡çŠ¶æ€æŒ‡ç¤ºå™¨
      Column()
        .width(4)
        .height(40)
        .backgroundColor(task.isCritical ? '#DC2626' : '#F59E0B')
        .borderRadius(2)

      // ä»»åŠ¡ä¿¡æ¯
      Column({ space: 4 }) {
        Text(task.name)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1F2937')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        Text(`æˆªæ­¢äº: ${task.endDate.toLocaleDateString()}`)
          .fontSize(12)
          .fontColor('#F59E0B')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // å…³é”®ä»»åŠ¡æ ‡è¯†
      if (task.isCritical) {
        Text('ğŸ”¥')
          .fontSize(14)
          .fontColor('#DC2626')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(10)
    .shadow({ radius: 4, color: '#00000008', offsetX: 0, offsetY: 1 })
    .border({ width: 1, color: '#FEF3C7', radius: 10 })
  }
}
